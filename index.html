<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercator Pole Explorer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #0a1628;
            --bg-mid: #132844;
            --bg-surface: #1a3a52;
            --accent-warm: #ff6b35;
            --accent-cool: #4ecdc4;
            --accent-gold: #f7b731;
            --text-primary: #e8f4f8;
            --text-secondary: #a0c4d4;
            --border: #2d5a7b;
            --land-fill: #4ecdc4;
            --land-hover: #ff6b35;
            --ocean-fill: transparent;
            --graticule-stroke: rgba(160, 196, 212, 0.2);
        }

        [data-theme="light"] {
            --bg-deep: #f5e6c8;
            --bg-mid: #efe0c0;
            --bg-surface: #e8d5b0;
            --accent-warm: #8b4513;
            --accent-cool: #5d4e37;
            --accent-gold: #c4a35a;
            --text-primary: #3d2b1f;
            --text-secondary: #6b5344;
            --border: #c4a574;
            --land-fill: #c9a66b;
            --land-hover: #8b4513;
            --ocean-fill: #d4c4a8;
            --graticule-stroke: rgba(139, 69, 19, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier Prime', monospace;
            background: linear-gradient(135deg, var(--bg-deep) 0%, var(--bg-mid) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 50%, rgba(78, 205, 196, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 107, 53, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        [data-theme="light"]::before {
            background-image:
                radial-gradient(circle at 20% 50%, rgba(139, 69, 19, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(196, 163, 90, 0.1) 0%, transparent 50%);
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.8s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 4rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cool), var(--accent-warm));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 400;
            letter-spacing: 0.05em;
        }

        .controls {
            background: rgba(26, 58, 82, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .search-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        input[type="text"] {
            flex: 1;
            background: var(--bg-deep);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-family: 'Courier Prime', monospace;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-cool);
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
        }

        input[type="text"]::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        button {
            background: linear-gradient(135deg, var(--accent-warm), #ff8c5a);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 2rem;
            color: white;
            font-family: 'Courier Prime', monospace;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 107, 53, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.reset {
            background: linear-gradient(135deg, var(--bg-surface), var(--border));
        }

        button.reset:hover {
            box-shadow: 0 8px 24px rgba(45, 90, 123, 0.4);
        }

        [data-theme="light"] button {
            background: linear-gradient(135deg, #8b4513, #a0522d);
        }

        [data-theme="light"] button:hover {
            box-shadow: 0 8px 24px rgba(139, 69, 19, 0.4);
        }

        [data-theme="light"] button.reset {
            background: linear-gradient(135deg, #c4a574, #a08060);
        }

        .theme-toggle {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 100;
            background: var(--bg-surface);
            border: 2px solid var(--border);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.3rem;
            padding: 0;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        [data-theme="light"] .theme-toggle {
            background: var(--bg-surface);
        }

        .info-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(10, 22, 40, 0.4);
            border-radius: 8px;
            border-left: 3px solid var(--accent-gold);
        }

        .current-pole {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(78, 205, 196, 0.3);
            font-size: 0.95rem;
        }

        .current-pole strong {
            color: var(--accent-cool);
            font-weight: 700;
        }

        #map-container {
            background: rgba(26, 58, 82, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.8s ease-out 0.4s both;
            position: relative;
            overflow: hidden;
        }

        #map-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(78, 205, 196, 0.03) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
            pointer-events: none;
        }

        [data-theme="light"] #map-container::before {
            background: radial-gradient(circle, rgba(139, 69, 19, 0.04) 0%, transparent 70%);
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        #map {
            width: 100%;
            height: 700px;
            cursor: grab;
            position: relative;
            z-index: 1;
        }

        #map:active,
        #map.dragging {
            cursor: grabbing;
        }

        .ocean {
            fill: var(--ocean-fill);
            cursor: inherit;
        }

        .land {
            fill: var(--land-fill);
            stroke: var(--bg-deep);
            stroke-width: 0.5px;
            transition: fill 0.3s ease;
        }

        .land:hover {
            fill: var(--land-hover);
        }

        .graticule {
            fill: none;
            stroke: var(--graticule-stroke);
            stroke-width: 0.5px;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--accent-cool);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        footer {
            text-align: center;
            margin-top: 3rem;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            animation: fadeIn 0.8s ease-out 0.6s both;
        }

        footer a {
            color: var(--accent-cool);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        footer a:hover {
            color: var(--accent-warm);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }

            .search-container {
                flex-direction: column;
            }

            #map {
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">
        <span id="theme-icon">&#9728;</span>
    </button>
    <div class="container">
        <header>
            <h1>Mercator Pole Explorer</h1>
            <p class="subtitle">Reimagine the world map with different pole locations</p>
        </header>

        <div class="controls">
            <div class="search-container">
                <input type="text" id="city-search" placeholder="Search for a city (e.g., Tokyo, Paris, Cairo)...">
                <button onclick="searchCity()">Set as Pole</button>
                <button class="reset" onclick="resetProjection()">Reset</button>
            </div>

            <div class="info-text">
                <strong>How to use:</strong> Click or drag anywhere on the map to set that location as the new north pole,
                or search for a city above. Watch how the Mercator projection distorts the world differently!
            </div>

            <div class="current-pole" id="pole-info">
                <strong>Current pole:</strong> North Pole (90°N, 0°E)
            </div>
        </div>

        <div id="map-container">
            <div id="map"></div>
        </div>

        <footer>
            <p>The Mercator projection preserves angles but distorts area, especially near the poles.
            Explore how different pole locations change what gets enlarged!</p>
        </footer>
    </div>

    <script>
        // Global variables
        let svg, projection, path, g, worldData;
        let currentPole = [0, -90]; // [longitude, latitude] for rotation
        let isDragging = false;

        // City database with major cities worldwide
        const cities = {
            // Africa
            'cairo': [31.2357, 30.0444],
            'lagos': [3.3792, 6.5244],
            'nairobi': [36.8219, -1.2921],
            'johannesburg': [28.0473, -26.2041],
            'casablanca': [-7.6167, 33.5731],
            'addis ababa': [38.7469, 9.0320],
            // Asia
            'tokyo': [139.6917, 35.6895],
            'beijing': [116.4074, 39.9042],
            'shanghai': [121.4737, 31.2304],
            'delhi': [77.1025, 28.7041],
            'mumbai': [72.8777, 19.0760],
            'bangkok': [100.5018, 13.7563],
            'singapore': [103.8198, 1.3521],
            'seoul': [126.9780, 37.5665],
            'hong kong': [114.1694, 22.3193],
            'dubai': [55.2708, 25.2048],
            'istanbul': [28.9784, 41.0082],
            'jakarta': [106.8456, -6.2088],
            'manila': [120.9842, 14.5995],
            // Europe
            'london': [-0.1276, 51.5074],
            'paris': [2.3522, 48.8566],
            'berlin': [13.4050, 52.5200],
            'rome': [12.4964, 41.9028],
            'madrid': [-3.7038, 40.4168],
            'moscow': [37.6173, 55.7558],
            'amsterdam': [4.9041, 52.3676],
            'vienna': [16.3738, 48.2082],
            'stockholm': [18.0686, 59.3293],
            'athens': [23.7275, 37.9838],
            // North America
            'new york': [-74.0060, 40.7128],
            'los angeles': [-118.2437, 34.0522],
            'chicago': [-87.6298, 41.8781],
            'mexico city': [-99.1332, 19.4326],
            'toronto': [-79.3832, 43.6532],
            'san francisco': [-122.4194, 37.7749],
            'miami': [-80.1918, 25.7617],
            'vancouver': [-123.1207, 49.2827],
            // South America
            'sao paulo': [-46.6333, -23.5505],
            'rio de janeiro': [-43.1729, -22.9068],
            'buenos aires': [-58.3816, -34.6037],
            'lima': [-77.0428, -12.0464],
            'bogota': [-74.0721, 4.7110],
            'santiago': [-70.6483, -33.4489],
            // Oceania
            'sydney': [151.2093, -33.8688],
            'melbourne': [144.9631, -37.8136],
            'auckland': [174.7633, -36.8485],
            'perth': [115.8605, -31.9505],
            // Extreme/Interesting locations
            'reykjavik': [-21.8952, 64.1466],
            'anchorage': [-149.9003, 61.2181],
            'ushuaia': [-68.3029, -54.8019],
            'wellington': [174.7787, -41.2865],
            'murmansk': [33.0750, 68.9585],
        };

        // Initialize the map
        function init() {
            const width = document.getElementById('map').clientWidth;
            const height = 700;

            // Create SVG with drag behavior
            svg = d3.select('#map')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .call(d3.drag()
                    .on('start', handleDragStart)
                    .on('drag', handleDrag)
                    .on('end', handleDragEnd));

            // Create projection
            projection = d3.geoMercator()
                .scale(width / (2 * Math.PI))
                .translate([width / 2, height / 2]);

            // Create path generator
            path = d3.geoPath().projection(projection);

            // Create group for all map elements
            g = svg.append('g');

            // Add ocean background rectangle that captures all clicks
            g.append('rect')
                .attr('class', 'ocean')
                .attr('width', width)
                .attr('height', height)
                .on('click', handleMapClick);

            // Add graticule (grid lines)
            const graticule = d3.geoGraticule();
            g.append('path')
                .datum(graticule)
                .attr('class', 'graticule')
                .attr('d', path);

            // Load world data
            d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
                .then(data => {
                    worldData = data;
                    const countries = topojson.feature(data, data.objects.countries);

                    // Draw countries
                    g.selectAll('.land')
                        .data(countries.features)
                        .enter()
                        .append('path')
                        .attr('class', 'land')
                        .attr('d', path)
                        .on('click', handleMapClick);
                })
                .catch(error => {
                    console.error('Error loading map data:', error);
                    d3.select('#map').html('<div class="loading">Error loading map data. Please refresh the page.</div>');
                });
        }

        // Handle map click
        function handleMapClick(event, d) {
            // Don't handle click if we just finished dragging
            if (isDragging) return;

            const coords = projection.invert(d3.pointer(event));
            if (coords) {
                setPole(coords[0], coords[1]);
            }
        }

        // Handle drag start
        function handleDragStart(event) {
            isDragging = true;
            document.getElementById('map').classList.add('dragging');
        }

        // Handle drag movement
        function handleDrag(event) {
            const coords = projection.invert([event.x, event.y]);
            if (coords && !isNaN(coords[0]) && !isNaN(coords[1])) {
                // Clamp latitude to avoid issues near poles
                const lat = Math.max(-85, Math.min(85, coords[1]));
                setPoleImmediate(coords[0], lat);
            }
        }

        // Handle drag end
        function handleDragEnd(event) {
            document.getElementById('map').classList.remove('dragging');
            // Small delay before allowing clicks again
            setTimeout(() => { isDragging = false; }, 100);
        }

        // Set new pole location (with animation)
        function setPole(lon, lat) {
            currentPole = [lon, -lat]; // Negative because we're rotating TO this point
            updateProjection();
            updatePoleInfo(lon, lat);
        }

        // Set new pole location immediately (no animation, for dragging)
        function setPoleImmediate(lon, lat) {
            currentPole = [lon, -lat];
            updateProjectionImmediate();
            updatePoleInfo(lon, lat);
        }

        // Update the projection with new rotation
        function updateProjection() {
            // Create a new projection with rotation
            const width = document.getElementById('map').clientWidth;
            const height = 700;

            projection = d3.geoMercator()
                .rotate(currentPole)
                .scale(width / (2 * Math.PI))
                .translate([width / 2, height / 2]);

            path = d3.geoPath().projection(projection);

            // Update all paths with animation
            const graticule = d3.geoGraticule();

            g.select('.graticule')
                .transition()
                .duration(1000)
                .attr('d', path.projection(projection)(graticule()));

            g.selectAll('.land')
                .transition()
                .duration(1000)
                .attr('d', path);
        }

        // Update the projection immediately (no animation, for dragging)
        function updateProjectionImmediate() {
            const width = document.getElementById('map').clientWidth;
            const height = 700;

            projection = d3.geoMercator()
                .rotate(currentPole)
                .scale(width / (2 * Math.PI))
                .translate([width / 2, height / 2]);

            path = d3.geoPath().projection(projection);

            // Update all paths immediately (no transition)
            const graticule = d3.geoGraticule();

            g.select('.graticule')
                .attr('d', path.projection(projection)(graticule()));

            g.selectAll('.land')
                .attr('d', path);
        }

        // Update pole information display
        function updatePoleInfo(lon, lat) {
            const lonDir = lon >= 0 ? 'E' : 'W';
            const latDir = lat >= 0 ? 'N' : 'S';
            const lonAbs = Math.abs(lon).toFixed(2);
            const latAbs = Math.abs(lat).toFixed(2);

            document.getElementById('pole-info').innerHTML =
                `<strong>Current pole:</strong> ${latAbs}°${latDir}, ${lonAbs}°${lonDir}`;
        }

        // Search for a city
        function searchCity() {
            const searchTerm = document.getElementById('city-search').value.toLowerCase().trim();

            if (cities[searchTerm]) {
                const [lon, lat] = cities[searchTerm];
                setPole(lon, lat);

                // Update search box with proper capitalization
                const cityName = searchTerm.split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                document.getElementById('city-search').value = cityName;
            } else {
                alert('City not found. Try: Tokyo, Paris, Cairo, New York, Sydney, etc.');
            }
        }

        // Reset to original projection
        function resetProjection() {
            currentPole = [0, -90];
            updateProjection();
            document.getElementById('pole-info').innerHTML =
                '<strong>Current pole:</strong> North Pole (90°N, 0°E)';
            document.getElementById('city-search').value = '';
        }

        // Handle enter key in search box
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('city-search').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchCity();
                }
            });

            // Initialize the map
            init();
        });

        // Theme toggle function
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');

            if (body.getAttribute('data-theme') === 'light') {
                body.removeAttribute('data-theme');
                icon.innerHTML = '&#9728;'; // Sun icon for dark mode
            } else {
                body.setAttribute('data-theme', 'light');
                icon.innerHTML = '&#9790;'; // Moon icon for light mode
            }
        }

        // Handle window resize
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                d3.select('#map svg').remove();
                init();
            }, 250);
        });
    </script>
</body>
</html>
